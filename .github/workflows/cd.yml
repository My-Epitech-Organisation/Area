name: CD - Deploy to Production

# =============================================================================
# âš ï¸  IMPORTANT: This workflow ONLY runs if the CI workflow passes successfully
#
# Trigger conditions:
#   1. Automatically after CI completes successfully on main/master
#   2. Manually via GitHub UI (workflow_dispatch)
#
# CI Jobs that must pass:
#   âœ… check-changes
#   âœ… backend-ci (if backend changed)
#   âœ… frontend-ci (if frontend changed)
#   âœ… mobile-ci (if mobile changed)
#   âœ… docker-compose-validation
#
# If ANY CI job fails â†’ CD will NOT run
# =============================================================================

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger from GitHub UI

# Only run one deployment at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Deploy to Production Server
  # ---------------------------------------------------------------------------
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest

    # Only deploy if:
    #   - Manual trigger (workflow_dispatch) OR
    #   - CI passed successfully AND on main/master branch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' ||
        github.event.workflow_run.head_branch == 'master'))

    # Environment protection (optional: configure in GitHub repo settings)
    environment:
      name: production
      url: https://areaction.app

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout (for access to deployment scripts if needed)
      # -----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Deploy via SSH
      # -----------------------------------------------------------------------
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: areaction
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  AREA Production Deployment"
            echo "  Server: ${{ secrets.PROD_SERVER_HOST }}"
            echo "  Branch: ${{ github.ref_name }}"
            echo "  Commit: ${{ github.sha }}"
            echo "  Triggered by: ${{ github.actor }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            # Navigate to project directory
            cd /opt/area

            # Check current status before deployment
            echo "ğŸ“Š Current status:"
            docker-compose ps || true
            echo ""

            # Execute deployment script
            echo "ğŸš€ Starting deployment..."
            ./deployment/manage.sh update

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  âœ… Deployment Complete!"
            echo "  ğŸŒ Application: https://areaction.app"
            echo "  ğŸ“Š API Health: https://areaction.app/health/"
            echo "  ğŸ“š API Docs: https://areaction.app/docs/"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # -----------------------------------------------------------------------
      # Step 3: Verify Deployment
      # -----------------------------------------------------------------------
      - name: ğŸ¥ Verify Deployment Health
        run: |
          echo "Waiting 10 seconds for services to stabilize..."
          sleep 10

          echo "Checking application health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://areaction.app/health/ || echo "000")

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $RESPONSE)"
          else
            echo "âš ï¸  Warning: Health check returned HTTP $RESPONSE"
            echo "This might be normal if services are still starting up"
          fi

      # -----------------------------------------------------------------------
      # Step 4: Notify on Success
      # -----------------------------------------------------------------------
      - name: âœ… Notify Success
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Deployment Successful!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Deployed commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ•’ Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸŒ URL: https://areaction.app"
          echo ""
          echo "Recent changes:"
          echo "${{ github.event.head_commit.message }}"

          # Optional: Add Discord/Slack notification here
          # Example:
          # curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
          #   -H "Content-Type: application/json" \
          #   -d '{"content": "âœ… Deployment successful! https://areaction.app"}'

      # -----------------------------------------------------------------------
      # Step 5: Notify on Failure
      # -----------------------------------------------------------------------
      - name: âŒ Notify Failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âŒ Deployment Failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Failed commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Attempted by: ${{ github.actor }}"
          echo "ğŸ•’ Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ” Check logs:"
          echo "   GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "   Server logs: ssh areaction@${{ secrets.PROD_SERVER_HOST }} 'cd /opt/area && ./deployment/manage.sh logs'"
          echo ""

          # Optional: Add Discord/Slack notification here
          # Example:
          # curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
          #   -H "Content-Type: application/json" \
          #   -d '{"content": "âŒ Deployment failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'

  # ---------------------------------------------------------------------------
  # Post-Deployment Checks (Optional)
  # ---------------------------------------------------------------------------
  post-deployment-checks:
    name: ğŸ” Post-Deployment Checks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: ğŸŒ Check API Endpoints
        run: |
          echo "Testing key API endpoints..."

          # Test about.json endpoint
          echo "â†’ Testing /about.json..."
          curl -f https://areaction.app/about.json || echo "âš ï¸  /about.json failed"

          # Test health endpoint
          echo "â†’ Testing /health/..."
          curl -f https://areaction.app/health/ || echo "âš ï¸  /health/ failed"

          # Test docs endpoint
          echo "â†’ Testing /docs/..."
          curl -f https://areaction.app/docs/ || echo "âš ï¸  /docs/ failed"

          echo "âœ… Post-deployment checks complete"
